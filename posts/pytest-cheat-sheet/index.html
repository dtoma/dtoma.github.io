<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Pytest cheat sheet :: dtoma blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Some notes on the features I use the most from pytest.
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://dtoma.github.io/posts/pytest-cheat-sheet/" />




<link rel="stylesheet" href="https://dtoma.github.io/assets/style.css">






<link rel="apple-touch-icon" href="https://dtoma.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://dtoma.github.io/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Pytest cheat sheet">
<meta property="og:description" content="Some notes on the features I use the most from pytest.
" />
<meta property="og:url" content="https://dtoma.github.io/posts/pytest-cheat-sheet/" />
<meta property="og:site_name" content="dtoma blog" />

  
    <meta property="og:image" content="https://dtoma.github.io/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2019-04-05 00:00:00 &#43;0000 UTC" />












</head>
<body class="orange">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
     &lt; Home &gt; 
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://dtoma.github.io/posts/pytest-cheat-sheet/">Pytest cheat sheet</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2019-04-05 
      </span>
    
    
  </div>

  

  

  

  <div class="post-content"><div>
        <p>Some notes on the features I use the most from <a href="https://docs.pytest.org/en/latest/">pytest</a>.</p>
<h2 id="setupteardown">SetUp/TearDown<a href="#setupteardown" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We can use <code>yield</code> in pytest fixtures to emulate class-based tests SetUp/TearDown methods.
It works particularly well with decorators - the example below will run <code>test_foo</code> with a patched <code>module.function</code>, then reset the patched function after the test finishes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> unittest.mock <span style="color:#f92672">import</span> patch
<span style="color:#f92672">import</span> pytest

<span style="color:#a6e22e">@pytest</span><span style="color:#f92672">.</span>fixture
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_fixture</span>():
    <span style="color:#66d9ef">with</span> patch(<span style="color:#e6db74">&#39;module.function&#39;</span>, return_value<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>)
        <span style="color:#66d9ef">yield</span>

<span style="color:#a6e22e">@pytest</span><span style="color:#f92672">.</span>mark<span style="color:#f92672">.</span>usefixtures(<span style="color:#e6db74">&#39;my_fixture&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_foo</span>():
    <span style="color:#f92672">import</span> module
    <span style="color:#66d9ef">assert</span> module<span style="color:#f92672">.</span>function() <span style="color:#f92672">==</span> <span style="color:#ae81ff">42</span>
</code></pre></div><h2 id="fixtures-scope-and-autouse">Fixtures scope and autouse<a href="#fixtures-scope-and-autouse" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Fixtures can have a scope that is one of:</p>
<ul>
<li>function</li>
<li>class</li>
<li>module</li>
<li>package</li>
<li>session (the whole test run)</li>
</ul>
<p>With the <code>autouse</code> parameter, we can automatically load a function for all the tests in a module, for example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mymodels <span style="color:#f92672">import</span> SomeModel

<span style="color:#a6e22e">@django_db</span>
<span style="color:#a6e22e">@pytest</span><span style="color:#f92672">.</span>fixture(scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;module&#39;</span>, autouse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fixture_populate_database</span>():
    SomeModel<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(foo<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Bar&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_foo_is_bar</span>():
    <span style="color:#66d9ef">assert</span> list(SomeModel<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values_list(<span style="color:#e6db74">&#39;foo&#39;</span>)) <span style="color:#f92672">==</span> [<span style="color:#e6db74">&#39;bar&#39;</span>]
</code></pre></div><p>Sadly, we can&rsquo;t use session-level fixtures that require a database access. There is a <a href="https://github.com/pytest-dev/pytest-django/issues/514">GitHub issue</a> open.</p>
<h2 id="testing-logs">Testing logs<a href="#testing-logs" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We can use the <code>caplog</code> fixture, then filter its output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_my_logs</span>(caplog):
    fixture <span style="color:#f92672">=</span> some_fixture()

    <span style="color:#66d9ef">assert</span> some_function() <span style="color:#f92672">==</span> some_result

    <span style="color:#75715e"># filter by level and logger</span>
    info_logs <span style="color:#f92672">=</span> [
        line
        <span style="color:#66d9ef">for</span> logger, level, line <span style="color:#f92672">in</span> caplog<span style="color:#f92672">.</span>record_tuples
        <span style="color:#66d9ef">if</span> level <span style="color:#f92672">==</span> logging<span style="color:#f92672">.</span>INFO <span style="color:#f92672">and</span> logger <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;some_module.some_function&#39;</span>
    ]

    <span style="color:#75715e"># assert the logs are what we expected</span>
    <span style="color:#66d9ef">assert</span> info_logs <span style="color:#f92672">==</span> [
        <span style="color:#e6db74">&#39;first message&#39;</span>,
        <span style="color:#e6db74">&#39;second_message&#39;</span>,
        <span style="color:#e6db74">&#39;third_message: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> fixture<span style="color:#f92672">.</span>id,
    ]
</code></pre></div><h2 id="parametrized-tests">Parametrized tests<a href="#parametrized-tests" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>It can be useful to run a single test over multiple inputs. Using the <code>parametrize</code> decorator,
we can list inputs that we expect to succeed or fail.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@pytest</span><span style="color:#f92672">.</span>mark<span style="color:#f92672">.</span>parametrize(
    <span style="color:#e6db74">&#34;test_input,expected&#34;</span>,
    [
        (<span style="color:#e6db74">&#34;3+5&#34;</span>, <span style="color:#ae81ff">8</span>),
        (<span style="color:#e6db74">&#34;2+4&#34;</span>, <span style="color:#ae81ff">6</span>),
        pytest<span style="color:#f92672">.</span>param(<span style="color:#e6db74">&#34;6*9&#34;</span>, <span style="color:#ae81ff">42</span>, marks<span style="color:#f92672">=</span>pytest<span style="color:#f92672">.</span>mark<span style="color:#f92672">.</span>xfail)
    ],
)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_eval</span>(test_input, expected):
    <span style="color:#66d9ef">assert</span> eval(test_input) <span style="color:#f92672">==</span> expected
</code></pre></div>
      </div></div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://dtoma.github.io/assets/main.js"></script>
<script src="https://dtoma.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
