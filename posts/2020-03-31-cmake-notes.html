<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Notes on CMake</title>
    <link rel="stylesheet" href="../css/bootstrap-reboot.min.css" />
    <link rel="stylesheet" href="../css/bootstrap-grid.min.css" />
    <link rel="stylesheet" href="../css/default.css" />
    <link rel="stylesheet" href="../css/code.css" />

    <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
    <link rel="manifest" href="../images/site.webmanifest">
</head>

<body>
    <div class="container">
        <header class="py-3 col-12" style="text-align: center;">
            <a href="../">Home</a>
        </header>
        <div class="row">
            <div class="col-xl-9">
                <h1>Notes on CMake</h1>

<div class="toc">
<ul>
<li><a href="#useful-resources">Useful Resources</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#installing-dependencies-that-use-other-build-systems">Installing Dependencies That Use Other Build Systems</a></li>
<li><a href="#installing-dependencies-that-use-cmake">Installing Dependencies That Use CMake</a></li>
<li><a href="#running-tests">Running Tests</a></li>
<li><a href="#build-type">Build type</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#custom-targets">Custom Targets</a></li>
</ul>
</div>
<h2 id="useful-resources">Useful Resources</h2>
<ul>
<li><a href="https://crascit.com/professional-cmake/">Professional CMake</a> Book</li>
<li>CMake <a href="https://cmake.org/cmake/help/latest/">official documentation</a></li>
<li>CTest <a href="https://gitlab.kitware.com/cmake/community/-/wikis/doc/ctest/Testing-With-CTest">Wiki</a></li>
</ul>
<h2 id="getting-started">Getting Started</h2>
<p>The simplest <code>CMakeLists.txt</code> contains:</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">cmake_minimum_required</span>(<span class="ot">VERSION</span> 3.2)

<span class="co"># `VERSION` and `LANGUAGES` are optional</span>
<span class="kw">project</span>(myProject <span class="ot">VERSION</span> 0.0.1 <span class="ot">LANGUAGES</span> CXX)
<span class="kw">add_executable</span>(example main.cpp)</code></pre></div>
<p>We can generate build files for the current platform, then build an executable:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">mkdir</span> build <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> build  # Out-of-source build
<span class="fu">cmake</span> ..                 # Generate build files
<span class="fu">cmake</span> --build .          # Run build
<span class="ex">./Debug/example.exe</span>      # Run the resulting binary</code></pre></div>
<h2 id="installing-dependencies-that-use-other-build-systems">Installing Dependencies That Use Other Build Systems</h2>
<p>This will create build steps at configure time, and download/extract/build/etc. at build time. We then need to declare the dependencies in the right order. This incomplete example shows the gist of it:</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">include</span>(ExternalProject)

<span class="fu">ExternalProject_Add</span>(boost
    PREFIX boost
    URL https://dl.bintray.com/boostorg/release/1.72.0/source/boost_1_72_0.zip
    URL_HASH SHA256=8c20440aaba21dd963c0f7149517445f50c62ce4eb689df2b5544cc89e6e621e
    CONFIGURE_COMMAND <span class="va">${_BOOTSTRAP_COMMAND}</span>
    BUILD_COMMAND <span class="va">${_B2_COMMAND}</span>
    BUILD_IN_SOURCE 1
    INSTALL_COMMAND <span class="st">&quot;&quot;</span>
)</code></pre></div>
<p>Resources:</p>
<ul>
<li><a href="https://github.com/apache/geode-native/blob/develop/dependencies/boost/CMakeLists.txt">Installing Boost</a></li>
</ul>
<h2 id="installing-dependencies-that-use-cmake">Installing Dependencies That Use CMake</h2>
<p>We can use <code>CMake</code> to download and install dependencies.</p>
<p>The following setup will clone GitHub repos, and install the libraries using their CMake files during the build step:</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">cmake_minimum_required</span>(<span class="ot">VERSION</span> 3.8)

<span class="kw">include</span>(FetchContent)

<span class="fu">FetchContent_Declare</span>(googletest
  GIT_REPOSITORY https://github.com/google/googletest.git
  GIT_TAG release-1.10.0
)

<span class="fu">FetchContent_Declare</span>(fmt
  GIT_REPOSITORY https://github.com/fmtlib/fmt.git
  GIT_TAG 6.1.2
)

<span class="fu">FetchContent_Declare</span>(benchmark
  GIT_REPOSITORY https://github.com/google/benchmark
)

<span class="co"># Fix for googletest, otherwise we get LNK2038 errors on Windows</span>
<span class="kw">set</span>(gtest_force_shared_crt <span class="ot">ON</span> <span class="ot">CACHE</span> <span class="ot">BOOL</span> <span class="st">&quot;&quot;</span> <span class="ot">FORCE</span>)

<span class="co"># Clone repos and install libraries</span>
<span class="fu">FetchContent_MakeAvailable</span>(googletest fmt benchmark)</code></pre></div>
<p>Resources:</p>
<ul>
<li><a href="https://cmake.org/pipermail/cmake/2019-March/069206.html">Installing github.com/nlohmann/json</a> &lt;1&gt;</li>
<li><a href="https://github.com/nlohmann/json/issues/1634">Installing github.com/nlohmann/json</a> &lt;2&gt;</li>
</ul>
<h2 id="running-tests">Running Tests</h2>
<p>In the root <code>CMakeLists.txt</code>:</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">enable_testing</span>()
<span class="kw">include</span>(GoogleTest)

<span class="co"># This directory contains its own CMakeLists.txt</span>
<span class="kw">add_subdirectory</span>(test_directory)</code></pre></div>
<p>Using the following example test:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="pp">#include </span><span class="im">&quot;gtest/gtest.h&quot;</span>

TEST(Example, TestNothing) {
    EXPECT_EQ(<span class="dv">1</span>, <span class="dv">1</span>);
}</code></pre></div>
<p>We have a <code>CMakeLists.txt</code> in <code>test_directory</code> to builds the test(s):</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">add_executable</span>(myTests test.cpp)
<span class="kw">target_link_libraries</span>(myTests gtest_main)
<span class="fu">gtest_discover_tests</span>(myTests)</code></pre></div>
<p>Build, then run using <code>CTest</code>:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">cmake</span> ..         # Generate build files
<span class="fu">cmake</span> --build .  # Build test executable
<span class="ex">ctest</span>            # Run tests</code></pre></div>
<p>With the following example output:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">PS</span> C:\Users\damien\project\build<span class="op">&gt;</span> ctest
<span class="ex">Test</span> project C:\Users\damien\project\build
    <span class="ex">Start</span> 1: Example.TestNothing
<span class="ex">1/1</span> Test <span class="co">#1: Example.TestNothing .......   Passed    0.01 sec</span>

<span class="ex">100%</span> tests passed, 0 tests failed out of 1

<span class="ex">Total</span> Test time (real) =   <span class="ex">0.03</span> sec</code></pre></div>
<p><strong>! Caveat:</strong> After installing dependencies using <code>FetchContent_Declare</code>, <code>CTest</code> also picks up their tests.</p>
<p>I have found 2 workarounds so far:</p>
<ul>
<li>filter tests using <code>ctest -R &lt;MyTests&gt;</code> (run only tests with names containing <code>&lt;MyTests&gt;</code>)</li>
<li>when possible, set options to not build tests before the call to <code>FetchContent_MakeAvailable</code>, for example <code>set(BENCHMARK_ENABLE_TESTING OFF)</code></li>
</ul>
<h2 id="build-type">Build type</h2>
<ul>
<li>Release</li>
<li>Debug</li>
<li>RelWithDebInfo</li>
<li>MinSizeRel</li>
</ul>
<p>On some platforms, we can set the build type from the configuration generation phase:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">cmake</span> -G Ninja -DCMAKE_BUILD_TYPE:STRING=Release ../source
<span class="fu">cmake</span> --build .</code></pre></div>
<p>On other platforms eg. Windows, it has to be done at the build phase:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">cmake</span> ../source
<span class="fu">cmake</span> --build . --config Release</code></pre></div>
<h2 id="project-structure">Project Structure</h2>
<p>I like to use what seems to be called a “Superbuild” in CMake parlance:</p>
<blockquote>
<p>Where dependencies do not use CMake as their build system, a superbuild tends to be the preferred structure. This treats each dependency as its own separate build, with the main project directing the overall sequence and the way details are passed from one dependency’s build to another. Each separate build is added to the main build using <code>ExternalProject</code>. Such an arrangement allows CMake to look at what each build produces and automatically detect information that can then be passed on to other dependencies, thereby avoiding having to manually hard code that information in the main build.</p>
</blockquote>
<p><em>- Professional CMake 5th Edition</em></p>
<p>When necessary we can use <code>ExternalProject</code>, and when we can there is the simpler <code>FetchContent</code> to install dependencies. Most projects already provide knobs to tweak builds, tests, and make it convenient to integrate their projects into ours.</p>
<pre><code>+------------------+-----------------+
| ExternalProjects |                 |
+------------------+                 |
|                                    +------+
|     Boost                          |      |
|                                    |      |
+------------------------------------+      |
                                            |
                                            |
+--------------+---------------------+      |
| FetchContent |                     |      |
+--------------+      fmt            |      |
|                                    &lt;------+
|    googletest                      |
|               google/benchmark     |
|       re2                          +------+
|            nlohmann/json           |      |
|                                    |      |
+------------------------------------+      |
                                            |
                                            |
+---------------+--------------------+      |
| Local Project |                    |      |
+---------------+                    |      |
|                                    &lt;------+
|     main.cpp     main.hpp          |
|                                    |
+------------------------------------+</code></pre>
<h2 id="custom-targets">Custom Targets</h2>
<p>As part of our workflow, we may need to call external commands or binaries. For example, if we build a benchmark suite:</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="kw">add_executable</span>(order_book_bench bench.cpp)

<span class="kw">target_link_libraries</span>(order_book_bench <span class="ot">PRIVATE</span> benchmark::benchmark order_book)

<span class="kw">add_custom_target</span>(runbench <span class="ot">COMMAND</span> order_book_bench)</code></pre></div>
<p>We can then call the target as follows:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="bu">cd</span> build <span class="kw">&amp;&amp;</span> <span class="fu">cmake</span> --build . --target runbench</code></pre></div>
            </div>
            <div class="col-xl-3"></div>
        </div>
        <footer class="py-3"></footer>
    </div>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->
</body>

</html>